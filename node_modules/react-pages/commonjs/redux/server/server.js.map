{"version":3,"file":"server.js","names":["initialize","settings","proxy","cookies","headers","locales","url","origin","location","getLoadContext","getInitialState","httpClient","createHttpClient","store","server","fetch","undefined","initialState","navigationLocation","getNavigationLocation","stash","Stash","createStore","createHistoryProtocol","options","getCookie","name","context","dispatch","action","generateJavascript","cookiesSetOnServer","code","parseDates","DEFINE_JSON_DATE_PARSER","JSON","stringify","safeJsonStringify","getState","IsoDatePattern","indexOf","Error"],"sources":["../../../lib/redux/server/server.js"],"sourcesContent":["// Currently, `fetch` is not used.\r\n// But it could be used in some future instead of `superagent`.\r\n//\r\n// While it's not used, I've commented it out\r\n// because it broke CommonJS import support.\r\n//\r\n// import fetch from 'node-fetch'\r\n\r\nimport { IsoDatePattern } from '../../parseDates.js'\r\nimport { safeJsonStringify } from '../../server/html.js'\r\nimport createStore from '../store.js'\r\nimport Stash from '../Stash.js'\r\nimport createHttpClient from '../HttpClient.js'\r\nimport createHistoryProtocol from '../../router/server/createHistoryProtocol.js'\r\nimport getNavigationLocation from '../navigation/getNavigationLocation.js'\r\n\r\nexport async function initialize(settings, {\r\n\tproxy,\r\n\tcookies,\r\n\theaders,\r\n\tlocales,\r\n\turl,\r\n\torigin,\r\n\tlocation,\r\n\tgetLoadContext,\r\n\tgetInitialState\r\n}) {\r\n\t// Redux store.\r\n\t// This variable is used in `httpClient`,\r\n\t// that's why it's declared at the top.\r\n\tlet store\r\n\r\n\t// Create HTTP client (Redux action creator `http` utility)\r\n\tconst httpClient = createHttpClient(settings, () => store, {\r\n\t\tproxy,\r\n\t\tcookies,\r\n\t\tserver: true,\r\n\t\tfetch: undefined\r\n\t})\r\n\r\n\t// Initial Redux state.\r\n\t// `User-Agent` and `Accept-Language` headers were requested:\r\n\t// https://github.com/catamphetamine/react-website/issues/72\r\n\tconst initialState = getInitialState ? getInitialState({\r\n\t\tcookies,\r\n\t\theaders,\r\n\t\tlocales\r\n\t}) : {}\r\n\r\n\t// `found` router doesn't emit `UPDATE_MATCH` or `RESOLVE_MATCH` events on the server side.\r\n\t// So `navigationLocation` property is not set in Redux state dynamically via `dispatch()`.\r\n\t// For that reason, `navigationLocation` property should be set in the initial state.\r\n\tinitialState.navigationLocation = getNavigationLocation(location)\r\n\r\n\t// Create utility data stash.\r\n\tconst stash = new Stash()\r\n\r\n\t// Create Redux store.\r\n\tstore = createStore({\r\n\t\tinitialState,\r\n\t\tcreateHistoryProtocol: () => createHistoryProtocol({ url, origin }),\r\n\t\thttpClient,\r\n\t\tstash,\r\n\t\tsettings,\r\n\t\toptions: {\r\n\t\t\tgetCookie: name => cookies[name],\r\n\t\t\tserver: true,\r\n\t\t\tcontext: getLoadContext && getLoadContext({\r\n\t\t\t\tdispatch: (action) => store.dispatch(action)\r\n\t\t\t})\r\n\t\t}\r\n\t})\r\n\r\n\treturn {\r\n\t\tstore,\r\n\t\tstash,\r\n\t\tgenerateJavascript: () => generateJavascript(store, settings),\r\n\t\tcookies: httpClient.cookiesSetOnServer\r\n\t}\r\n}\r\n\r\nfunction generateJavascript(store, settings) {\r\n\tlet code = ''\r\n\r\n\t// JSON Date deserializer\r\n\tif (settings.parseDates) {\r\n\t\tcode += `<script>${DEFINE_JSON_DATE_PARSER}</script>`\r\n\t}\r\n\r\n\t// Store data will be reloaded into the store on the client-side.\r\n\t// All forward slashes are escaped to prevent XSS attacks.\r\n\t// Another solution would be replacing with `\\uxxxx` sequences.\r\n\t// https://medium.com/node-security/the-most-common-xss-vulnerability-in-react-js-applications-2bdffbcc1fa0\r\n\tcode += `<script>`\r\n\tcode += `window._ReactPages_ReduxStateServerSideSnapshot = JSON.parse(${ JSON.stringify(safeJsonStringify(store.getState())) }${ settings.parseDates ? ', JSON.dateParser' : '' })`\r\n\tcode += `</script>`\r\n\r\n\treturn code\r\n}\r\n\r\n// JSON date deserializer.\r\n// Use as the second, 'reviver' argument to `JSON.parse(json, JSON.dateParser)`.\r\n// http://stackoverflow.com/questions/14488745/javascript-json-date-deserialization/23691273#23691273\r\n// `JSON.parse(json, JSON.dateParser)` is about 2.5 times slower than `JSON.parse(json)` in Chrome.\r\nconst DEFINE_JSON_DATE_PARSER = `\r\nif (!JSON.dateParser) {\r\n\tJSON.dateParser = function(key, value) {\r\n\t\tif (typeof value === 'string' && /^${IsoDatePattern}$/.test(value)) {\r\n\t\t\treturn new Date(value)\r\n\t\t}\r\n\t\treturn value\r\n\t}\r\n}`\r\n\r\n// Since version 6.x, `terser` no longer provides a synchronous `minify()` function.\r\n// import Terser from 'terser'\r\n// DEFINE_JSON_DATE_PARSER = Terser.minify(DEFINE_JSON_DATE_PARSER).code\r\n\r\n// Just to be extra safe from XSS attacks\r\nif (DEFINE_JSON_DATE_PARSER.indexOf('<') !== -1) {\r\n\tthrow new Error('JSON Date parser XSS vulnerability detected')\r\n}"],"mappings":";;;;;;AAQA;AACA;AACA;AACA;AACA;AACA;AACA;AAA0E;AAAA;AAAA,+CAb1E;AAAA;AAAA;AAAA,SAesBA,UAAU;EAAA;AAAA;AAAA;EAAA,yEAAzB,iBAA0BC,QAAQ;IAAA;IAAA;MAAA;QAAA;UACxCC,KAAK,QAALA,KAAK,EACLC,OAAO,QAAPA,OAAO,EACPC,OAAO,QAAPA,OAAO,EACPC,OAAO,QAAPA,OAAO,EACPC,GAAG,QAAHA,GAAG,EACHC,MAAM,QAANA,MAAM,EACNC,QAAQ,QAARA,QAAQ,EACRC,cAAc,QAAdA,cAAc,EACdC,eAAe,QAAfA,eAAe;UAOf;UACMC,UAAU,GAAG,IAAAC,sBAAgB,EAACX,QAAQ,EAAE;YAAA,OAAMY,KAAK;UAAA,GAAE;YAC1DX,KAAK,EAALA,KAAK;YACLC,OAAO,EAAPA,OAAO;YACPW,MAAM,EAAE,IAAI;YACZC,KAAK,EAAEC;UACR,CAAC,CAAC,EAEF;UACA;UACA;UACMC,YAAY,GAAGP,eAAe,GAAGA,eAAe,CAAC;YACtDP,OAAO,EAAPA,OAAO;YACPC,OAAO,EAAPA,OAAO;YACPC,OAAO,EAAPA;UACD,CAAC,CAAC,GAAG,CAAC,CAAC,EAEP;UACA;UACA;UACAY,YAAY,CAACC,kBAAkB,GAAG,IAAAC,iCAAqB,EAACX,QAAQ,CAAC;;UAEjE;UACMY,KAAK,GAAG,IAAIC,iBAAK,EAAE,EAEzB;UACAR,KAAK,GAAG,IAAAS,iBAAW,EAAC;YACnBL,YAAY,EAAZA,YAAY;YACZM,qBAAqB,EAAE;cAAA,OAAM,IAAAA,kCAAqB,EAAC;gBAAEjB,GAAG,EAAHA,GAAG;gBAAEC,MAAM,EAANA;cAAO,CAAC,CAAC;YAAA;YACnEI,UAAU,EAAVA,UAAU;YACVS,KAAK,EAALA,KAAK;YACLnB,QAAQ,EAARA,QAAQ;YACRuB,OAAO,EAAE;cACRC,SAAS,EAAE,mBAAAC,IAAI;gBAAA,OAAIvB,OAAO,CAACuB,IAAI,CAAC;cAAA;cAChCZ,MAAM,EAAE,IAAI;cACZa,OAAO,EAAElB,cAAc,IAAIA,cAAc,CAAC;gBACzCmB,QAAQ,EAAE,kBAACC,MAAM;kBAAA,OAAKhB,KAAK,CAACe,QAAQ,CAACC,MAAM,CAAC;gBAAA;cAC7C,CAAC;YACF;UACD,CAAC,CAAC;UAAA,iCAEK;YACNhB,KAAK,EAALA,KAAK;YACLO,KAAK,EAALA,KAAK;YACLU,kBAAkB,EAAE;cAAA,OAAMA,mBAAkB,CAACjB,KAAK,EAAEZ,QAAQ,CAAC;YAAA;YAC7DE,OAAO,EAAEQ,UAAU,CAACoB;UACrB,CAAC;QAAA;QAAA;UAAA;MAAA;IAAA;EAAA,CACD;EAAA;AAAA;AAED,SAASD,mBAAkB,CAACjB,KAAK,EAAEZ,QAAQ,EAAE;EAC5C,IAAI+B,IAAI,GAAG,EAAE;;EAEb;EACA,IAAI/B,QAAQ,CAACgC,UAAU,EAAE;IACxBD,IAAI,sBAAeE,uBAAuB,cAAW;EACtD;;EAEA;EACA;EACA;EACA;EACAF,IAAI,cAAc;EAClBA,IAAI,2EAAqEG,IAAI,CAACC,SAAS,CAAC,IAAAC,uBAAiB,EAACxB,KAAK,CAACyB,QAAQ,EAAE,CAAC,CAAC,SAAKrC,QAAQ,CAACgC,UAAU,GAAG,mBAAmB,GAAG,EAAE,MAAI;EACnLD,IAAI,eAAe;EAEnB,OAAOA,IAAI;AACZ;;AAEA;AACA;AACA;AACA;AACA,IAAME,uBAAuB,2HAGUK,0BAAc,qFAKnD;;AAEF;AACA;AACA;;AAEA;AACA,IAAIL,uBAAuB,CAACM,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,EAAE;EAChD,MAAM,IAAIC,KAAK,CAAC,6CAA6C,CAAC;AAC/D"}