{"version":3,"file":"render.js","names":["renderOnServer","store","stash","codeSplit","time","pageLoadTimer","timer","matchRoutes","renderArgs","RedirectException","redirect","url","location","statusCode","status","load","routes","elements","meta","mergeMeta","rootMeta","type","pageMeta","length","useSelector","getter","getState","route","getRoutePath","getHttpResponseStatusCodeForTheRoute","content","Router","rootComponentProps","matchedRoutes","reduce","previous","current"],"sources":["../../../lib/redux/server/render.js"],"sourcesContent":["import timer from '../../timer.js'\r\nimport mergeMeta from '../../meta/mergeMeta.js'\r\nimport { matchRoutes, RedirectException } from '../../router/index.js'\r\nimport getRoutePath from '../../router/getRoutePath.js'\r\nimport Router from '../../router/server/Router.js'\r\n\r\n// Returns a Promise resolving to { status, content, redirect }.\r\n//\r\nexport default async function renderOnServer({\r\n\tstore,\r\n\tstash,\r\n\t// routes,\r\n\tcodeSplit\r\n}) {\r\n\t// Routing only takes a couple of milliseconds\r\n\t// const routingTimer = timer()\r\n\r\n\t// Profiling\r\n\tconst time = {}\r\n\r\n\tconst pageLoadTimer = timer()\r\n\r\n\tlet renderArgs\r\n\ttry {\r\n\t\trenderArgs = await matchRoutes(store)\r\n\t} catch (error) {\r\n\t\t// Catches redirects from `load`s,\r\n\t\t// redirects from `settings.onLoadError()` and from `permanentRedirectTo` routes.\r\n\t\tif (error instanceof RedirectException) {\r\n\t\t\treturn {\r\n\t\t\t\tredirect: {\r\n\t\t\t\t\turl: error.location,\r\n\t\t\t\t\tstatusCode: error.status\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tthrow error\r\n\t}\r\n\r\n\ttime.load = pageLoadTimer()\r\n\r\n\t// Gather `<title/>` and `<meta/>` tags for this route path\r\n\tconst { routes, elements } = renderArgs\r\n\r\n\tconst meta = mergeMeta({\r\n\t\trootMeta: codeSplit ? routes[0].meta : elements[0].type.meta,\r\n\t\tpageMeta: codeSplit ? routes[routes.length - 1].meta : elements[elements.length - 1].type.meta,\r\n\t\tuseSelector: (getter) => getter(store.getState()),\r\n\t\tstash\r\n\t})\r\n\r\n\t// Return HTTP status code and the rendered page\r\n\treturn {\r\n\t\t// Concatenated route `path` string.\r\n\t\t// E.g. \"/user/:userId/post/:postId\"\r\n\t\troute: getRoutePath(routes),\r\n\t\tstatus: getHttpResponseStatusCodeForTheRoute(routes),\r\n\t\tcontent: Router(renderArgs),\r\n\t\tmeta,\r\n\t\trootComponentProps: { store },\r\n\t\ttime\r\n\t}\r\n}\r\n\r\n// One can set a `status` prop for a route\r\n// to be returned as an Http response status code (404, etc)\r\nfunction getHttpResponseStatusCodeForTheRoute(matchedRoutes)\r\n{\r\n\treturn matchedRoutes.reduce((previous, current) => (current && current.status) || (previous && current.status), null)\r\n}"],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AACA;AAAkD;AAAA;AAAA,+CAHlD;AAAA;AAAA;AAKA;AACA;AAAA,SAC8BA,cAAc;EAAA;AAAA,EAwD5C;AACA;AAAA;EAAA,6EAzDe;IAAA;IAAA;MAAA;QAAA;UACdC,KAAK,QAALA,KAAK,EACLC,KAAK,QAALA,KAAK,EAELC,SAAS,QAATA,SAAS;UAET;UACA;UAEA;UACMC,IAAI,GAAG,CAAC,CAAC;UAETC,aAAa,GAAG,IAAAC,iBAAK,GAAE;UAAA;UAAA;UAAA,OAIT,IAAAC,kBAAW,EAACN,KAAK,CAAC;QAAA;UAArCO,UAAU;UAAA;UAAA;QAAA;UAAA;UAAA;UAAA,MAIN,uBAAiBC,wBAAiB;YAAA;YAAA;UAAA;UAAA,iCAC9B;YACNC,QAAQ,EAAE;cACTC,GAAG,EAAE,YAAMC,QAAQ;cACnBC,UAAU,EAAE,YAAMC;YACnB;UACD,CAAC;QAAA;UAAA;QAAA;UAKHV,IAAI,CAACW,IAAI,GAAGV,aAAa,EAAE;;UAE3B;UAAA,cAC6BG,UAAU,EAA/BQ,MAAM,eAANA,MAAM,EAAEC,QAAQ,eAARA,QAAQ;UAElBC,IAAI,GAAG,IAAAC,qBAAS,EAAC;YACtBC,QAAQ,EAAEjB,SAAS,GAAGa,MAAM,CAAC,CAAC,CAAC,CAACE,IAAI,GAAGD,QAAQ,CAAC,CAAC,CAAC,CAACI,IAAI,CAACH,IAAI;YAC5DI,QAAQ,EAAEnB,SAAS,GAAGa,MAAM,CAACA,MAAM,CAACO,MAAM,GAAG,CAAC,CAAC,CAACL,IAAI,GAAGD,QAAQ,CAACA,QAAQ,CAACM,MAAM,GAAG,CAAC,CAAC,CAACF,IAAI,CAACH,IAAI;YAC9FM,WAAW,EAAE,qBAACC,MAAM;cAAA,OAAKA,MAAM,CAACxB,KAAK,CAACyB,QAAQ,EAAE,CAAC;YAAA;YACjDxB,KAAK,EAALA;UACD,CAAC,CAAC,EAEF;UAAA,iCACO;YACN;YACA;YACAyB,KAAK,EAAE,IAAAC,wBAAY,EAACZ,MAAM,CAAC;YAC3BF,MAAM,EAAEe,oCAAoC,CAACb,MAAM,CAAC;YACpDc,OAAO,EAAE,IAAAC,kBAAM,EAACvB,UAAU,CAAC;YAC3BU,IAAI,EAAJA,IAAI;YACJc,kBAAkB,EAAE;cAAE/B,KAAK,EAALA;YAAM,CAAC;YAC7BG,IAAI,EAAJA;UACD,CAAC;QAAA;QAAA;UAAA;MAAA;IAAA;EAAA,CACD;EAAA;AAAA;AAID,SAASyB,oCAAoC,CAACI,aAAa,EAC3D;EACC,OAAOA,aAAa,CAACC,MAAM,CAAC,UAACC,QAAQ,EAAEC,OAAO;IAAA,OAAMA,OAAO,IAAIA,OAAO,CAACtB,MAAM,IAAMqB,QAAQ,IAAIC,OAAO,CAACtB,MAAO;EAAA,GAAE,IAAI,CAAC;AACtH"}