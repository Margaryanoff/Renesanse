{"version":3,"file":"instantNavigation.js","names":["debug","getFromContext","console","log","addInstantBack","nextLocation","previousLocation","nextLocationRouteComponents","previousLocationRouteComponents","chain","getInstantNavigationChain","length","previousLocationIndex","indexOfByKey","getLocationKey","slice","key","routes","sameRoutesIndex","findSameRoutesLocationIndex","push","setInstantNavigationChain","setInstantNavigationChainIndex","isInstantTransition","fromLocation","toLocation","isInstant","resetInstantNavigationChain","setInContext","getInstantNavigationChainIndex","value","updateInstantNavigationChainIndex","location","i","error","j","wasInstantNavigation","window","isInstantBackAbleNavigation","setInstantNavigationFlag","setInstantBackAbilityFlagForThisNavigation","instantBack","setTimeout","clearInContext","isNavigationWithInstantBackAbility","canGoBackInstantly","canGoForwardInstantly"],"sources":["../../../lib/redux/client/instantNavigation.js"],"sourcesContent":["import { getFromContext, setInContext, clearInContext } from '../../context.js'\r\n\r\nconst debug = (...args) => {\r\n\tif (getFromContext('Navigation/InstantNavigationDebug')) {\r\n\t\tconsole.log(...args)\r\n\t}\r\n}\r\n\r\n/**\r\n * Is called when a `<Link/>` with `instantBack` property set is clicked.\r\n *\r\n * Stores \"current\" (soon to be \"previous\") location in \"instant back chain\",\r\n * so that if \"Back\" is clicked later then the transition to this\r\n * \"current\" (soon to be \"previous\") location is marked as \"should be instant\".\r\n *\r\n * \"Instant back chain\" consists of locations stored as a consequitive chain\r\n * and theoretically there can be more than one consequtive \"instant back\"-able\r\n * navigation in it (e.g. page1 -> page2 -> page3 -> \"Back\" -> page2 -> \"Back\" -> page3)\r\n * though I wouldn't advice doing that and would keep it minimal (a chain of two locations).\r\n *\r\n * Once a regular navigation is performed (i.e. not \"instant one\")\r\n * then the whole \"instant back chain\" is discarded.\r\n * E.g. a user clicks on `<Link instantBack/>` and is taken to a page\r\n * where he clicks on another `<Link/>` now without `instantBack` -\r\n * in this case all \"instant back\" history is discarded\r\n * and if the user clicks \"Back\" two times the second time won't be \"instant\".\r\n */\r\nexport function addInstantBack(\r\n\tnextLocation,\r\n\tpreviousLocation,\r\n\tnextLocationRouteComponents,\r\n\tpreviousLocationRouteComponents\r\n)\r\n{\r\n\tlet chain = getInstantNavigationChain()\r\n\r\n\tdebug('Add a new entry to instant navigation chain', {\r\n\t\tchain,\r\n\t\tnextLocation,\r\n\t\tpreviousLocation,\r\n\t\tnextLocationRouteComponents,\r\n\t\tpreviousLocationRouteComponents\r\n\t})\r\n\r\n\t// If there is already an \"instant\" transition in the chain\r\n\t// then insert this transition into the chain\r\n\t// only if it's \"page1 -> page2\" and \"page2 -> page3\"\r\n\t// so that the chain becomes \"page1 -> page2 -> page3\".\r\n\t// Otherwise, the already existing \"instant back\" chain is reset.\r\n\tif (chain.length > 0)\r\n\t{\r\n\t\tconst previousLocationIndex = indexOfByKey(chain, getLocationKey(previousLocation))\r\n\r\n\t\tif (previousLocationIndex >= 0)\r\n\t\t{\r\n\t\t\t// If transitioning from \"page2\" to \"page3\"\r\n\t\t\t// and the existing chain is \"page1 -> page2 -> page4\"\r\n\t\t\t// then trim the chain up to the \"current\" page\r\n\t\t\t// so that it becomes \"page1 -> page2\" (eligible for merging).\r\n\t\t\tchain = chain.slice(0, previousLocationIndex + 1)\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t// console.error('[react-pages] Error: previous location not found in an already existing instant back navigation chain', getLocationKey(previousLocation), chain)\r\n\t\t\t// Anomaly detected.\r\n\t\t\t// Reset the chain.\r\n\t\t\t// return resetInstantNavigationChain()\r\n\r\n\t\t\t// Basic recovery for cases where `history.replaceState()`\r\n\t\t\t// or `replaceHistory()` were called.\r\n\t\t\t// (e.g. Algolia \"Instant Search\" widget filters reconfigured)\r\n\t\t\tchain = []\r\n\t\t}\r\n\t}\r\n\r\n\tif (chain.length === 0)\r\n\t{\r\n\t\t// Add the \"current\" page to the chain.\r\n\t\tchain =\r\n\t\t[{\r\n\t\t\tkey: getLocationKey(previousLocation),\r\n\t\t\troutes: previousLocationRouteComponents\r\n\t\t}]\r\n\t}\r\n\r\n\t// Discard \"instant back\" chain part having same routes.\r\n\tconst sameRoutesIndex = findSameRoutesLocationIndex(chain, nextLocationRouteComponents)\r\n\tif (sameRoutesIndex >= 0) {\r\n\t\tchain = chain.slice(sameRoutesIndex + 1)\r\n\t}\r\n\r\n\t// Add the \"next\" page to the chain.\r\n\tchain.push({\r\n\t\tkey: getLocationKey(nextLocation),\r\n\t\troutes: nextLocationRouteComponents\r\n\t})\r\n\r\n\tdebug('Instant navigation chain (updated)', chain)\r\n\r\n\t// Save the chain.\r\n\tsetInstantNavigationChain(chain)\r\n\tsetInstantNavigationChainIndex(chain.length - 1)\r\n}\r\n\r\n/**\r\n * Checks if a \"Back\"/\"Forward\" transition should be \"instant\".\r\n * For \"Back\" transition it would mean that\r\n * the `<Link/>` has `instantBack` property set.\r\n * For \"Forward\" transition it would mean that\r\n * it's a reverse of an instant \"Back\" transition.\r\n * The order and position inside `chain` don't matter.\r\n */\r\nexport function isInstantTransition(fromLocation, toLocation)\r\n{\r\n\tconst chain = getInstantNavigationChain()\r\n\r\n\tconst isInstant = indexOfByKey(chain, getLocationKey(fromLocation)) >= 0 &&\r\n\t\tindexOfByKey(chain, getLocationKey(toLocation)) >= 0\r\n\r\n\tdebug('Is instant transition?', {\r\n\t\tchain,\r\n\t\tfromLocation,\r\n\t\ttoLocation,\r\n\t\tisInstant\r\n\t})\r\n\r\n\treturn isInstant\r\n}\r\n\r\n/**\r\n * Clears any \"instant back\" history.\r\n */\r\nexport function resetInstantNavigationChain() {\r\n\tdebug('Reset instant navigation chain')\r\n\r\n\tsetInstantNavigationChain([])\r\n\tsetInstantNavigationChainIndex(-1)\r\n}\r\n\r\nfunction getInstantNavigationChain() {\r\n\tif (!getFromContext('Navigation/InstantNavigationChain')) {\r\n\t\tsetInContext('Navigation/InstantNavigationChain', [])\r\n\t}\r\n\treturn getFromContext('Navigation/InstantNavigationChain')\r\n}\r\n\r\nfunction getInstantNavigationChainIndex() {\r\n\tif (!getFromContext('Navigation/InstantNavigationChainIndex')) {\r\n\t\tsetInContext('Navigation/InstantNavigationChainIndex', -1)\r\n\t}\r\n\treturn getFromContext('Navigation/InstantNavigationChainIndex')\r\n}\r\n\r\nfunction setInstantNavigationChain(value) {\r\n\tsetInContext('Navigation/InstantNavigationChain', value)\r\n}\r\n\r\nfunction setInstantNavigationChainIndex(value) {\r\n\tsetInContext('Navigation/InstantNavigationChainIndex', value)\r\n}\r\n\r\n/**\r\n * Updates instant navigation chain's current route index.\r\n */\r\nexport function updateInstantNavigationChainIndex(location) {\r\n\tconst chain = getInstantNavigationChain()\r\n\r\n\tlet i = 0\r\n\twhile (i < chain.length) {\r\n\t\tif (chain[i].key === getLocationKey(location)) {\r\n\t\t\tsetInstantNavigationChainIndex(i)\r\n\t\t\tdebug('Update index in instant navigation chain', { chain, location, i })\r\n\t\t\treturn\r\n\t\t}\r\n\t\ti++\r\n\t}\r\n\r\n\t// Shouldn't happen.\r\n\tconsole.error('[react-pages] Location not found in instant navigation chain', location, getInstantNavigationChain(), getInstantNavigationChainIndex())\r\n\tresetInstantNavigationChain()\r\n}\r\n\r\n/**\r\n * Each history `location` has a randomly generated `key`.\r\n */\r\nconst getLocationKey = location => location.key\r\n\r\nfunction indexOfByKey(chain, key) {\r\n\tlet i = 0\r\n\twhile (i < chain.length) {\r\n\t\tif (chain[i].key === key) {\r\n\t\t\treturn i\r\n\t\t}\r\n\t\ti++\r\n\t}\r\n\treturn -1\r\n}\r\n\r\nfunction findSameRoutesLocationIndex(chain, routes) {\r\n\tlet i = 0\r\n\twhile (i < chain.length) {\r\n\t\tif (chain[i].routes.length === routes.length) {\r\n\t\t\tlet j = 0\r\n\t\t\twhile (j < routes.length) {\r\n\t\t\t\tif (chain[i].routes[j] !== routes[j]) {\r\n\t\t\t\t\tbreak\r\n\t\t\t\t}\r\n\t\t\t\tj++\r\n\t\t\t}\r\n\t\t\tif (j === routes.length) {\r\n\t\t\t\treturn i\r\n\t\t\t}\r\n\t\t}\r\n\t\ti++\r\n\t}\r\n\treturn -1\r\n}\r\n\r\n// Can be used to find out if the current page\r\n// transition was an \"instant\" one.\r\n// E.g. an Algolia \"Instant Search\" component\r\n// could reset the stored cached `resultsState`\r\n// if the transition was not an \"instant\" one.\r\nexport function wasInstantNavigation() {\r\n\treturn typeof window !== 'undefined' && getFromContext('Navigation/WasInstant') === true\r\n}\r\n\r\nexport function isInstantBackAbleNavigation() {\r\n\treturn typeof window !== 'undefined' && getFromContext('Navigation/IsInstantBack')\r\n}\r\n\r\nexport function setInstantNavigationFlag(value) {\r\n\tsetInContext('Navigation/WasInstant', value)\r\n}\r\n\r\n/**\r\n * This function is also called with `false`\r\n * in order to set the flag to `false`.\r\n * Theoretically that might make sense in case of\r\n * two immediately consequtive `goto()` calls or something.\r\n * Though it's not a sane use case and may be considered invalid.\r\n * @param  {boolean} [instantBack]\r\n * @return\r\n */\r\nexport function setInstantBackAbilityFlagForThisNavigation(instantBack) {\r\n\t// This flag is being read in `./redux/middleware/router.js`\r\n\tsetInContext('Navigation/IsInstantBack', instantBack)\r\n\t// Resetting the flag immediately after it's processed in router's POP event listener.\r\n\t// Could reset it there too.\r\n\t// Not resetting on some \"on navigation finished\" event because\r\n\t// `load` could throw and the navigation wouldn't conclude in that case.\r\n\tsetTimeout(() => {\r\n\t\tclearInContext('Navigation/IsInstantBack')\r\n\t}, 0)\r\n}\r\n\r\nexport function isNavigationWithInstantBackAbility() {\r\n\treturn getFromContext('Navigation/IsInstantBack')\r\n}\r\n\r\nexport function canGoBackInstantly() {\r\n\treturn getInstantNavigationChainIndex() > 0\r\n}\r\n\r\nexport function canGoForwardInstantly() {\r\n\treturn getInstantNavigationChainIndex() < getInstantNavigationChain().length - 1\r\n}"],"mappings":"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"}