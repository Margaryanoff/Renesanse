{"version":3,"file":"initialPreload.js","names":["onHideInitialPreloadListeners","shouldShowInitialPreload","LoadingContainer","ref","onHidden","addHiddenListener","useState","loading","setLoading","onHiddenTimer","useRef","onHide","current","setTimeout","useEffect","clearTimeout","React","createElement","Loading","initial","immediate","pending","forwardRef","showInitialPreload","container","document","body","insertBefore","firstChild","reactRender","root","unmount","removeChild","listener","push","hideInitialPreload","onHideInitialPreloadListener"],"sources":["../../../lib/redux/client/initialPreload.js"],"sourcesContent":["import React, { useState, useRef, useEffect, useImperativeHandle } from 'react'\r\nimport ReactDOM from 'react-dom'\r\n\r\nimport { Loading } from '../../components/Loading.js'\r\nimport reactRender from '../../client/reactRender.js'\r\n\r\n// In cases when the initial page immediately redirects\r\n// to another page (for example, to a \"not found\" page),\r\n// a `RedirectException` is thrown in `setUpAndRender()` function\r\n// in which case that function re-runs from scratch.\r\n//\r\n// That would result in `showInitialPreload()` function\r\n// getting called multiple times, resulting in it creating\r\n// multiple `<LoadingContainer/>` DOM Elements.\r\n//\r\n// Therefore, when calling `hideInitialPreload()`,\r\n// it should assume there're multiple initial preloaders on apage.\r\n\r\n// let containers = []\r\n// let refs = []\r\n\r\nconst onHideInitialPreloadListeners = []\r\nconst shouldShowInitialPreload = true\r\n\r\nfunction LoadingContainer({ onHidden, addHiddenListener }, ref) {\r\n\tconst [loading, setLoading] = useState(true)\r\n\r\n\t// const onFinishedLoadingCallback = useRef()\r\n\tconst onHiddenTimer = useRef()\r\n\r\n\t// // Provides a `setLoading()` instance method.\r\n\t// useImperativeHandle(ref, () => ({\r\n\t// \tsetFinishedLoading: (callback) => {\r\n\t// \t\tonFinishedLoadingCallback.current = callback\r\n\t// \t\tsetLoading(false)\r\n\t// \t}\r\n\t// }), [\r\n\t// \tonFinishedLoadingCallback,\r\n\t// \tsetLoading\r\n\t// ])\r\n\r\n\t// useEffect(() => {\r\n\t// \tif (!loading) {\r\n\t// \t\tonFinishedLoadingCallback.current()\r\n\t// \t\tonFinishedLoadingCallback.current = undefined\r\n\t// \t}\r\n\t// }, [loading])\r\n\r\n\tconst onHide = () => {\r\n\t\tsetLoading(false)\r\n\t\tonHiddenTimer.current = setTimeout(onHidden, 160)\r\n\t}\r\n\r\n\tuseEffect(() => {\r\n\t\tif (!shouldShowInitialPreload) {\r\n\t\t\tonHide()\r\n\t\t} else {\r\n\t\t\taddHiddenListener(onHide)\r\n\t\t}\r\n\t\treturn () => {\r\n\t\t\tclearTimeout(onHiddenTimer.current)\r\n\t\t}\r\n\t}, [])\r\n\r\n\treturn React.createElement(Loading, {\r\n\t\tinitial: loading,\r\n\t\timmediate: loading,\r\n\t\tpending: loading\r\n\t})\r\n}\r\n\r\nLoadingContainer = React.forwardRef(LoadingContainer)\r\n\r\nexport function showInitialPreload() {\r\n\tconst container = document.createElement('div')\r\n\t// containers.push(container)\r\n\r\n\t// Will prepend `element` to `<body/>` (even if `<body/>` is empty).\r\n\t// https://stackoverflow.com/questions/2007357/how-to-set-dom-element-as-the-first-child\r\n\tdocument.body.insertBefore(container, document.body.firstChild)\r\n\r\n\t// const setRef = (ref) => {\r\n\t// \t// Update the `ref` that corresponds to the `container`.\r\n\t// \tconst index = containers.indexOf(container)\r\n\t// \tif (index >= 0) {\r\n\t// \t\trefs[index] = ref\r\n\t// \t}\r\n\t// }\r\n\r\n\tconst { root } = reactRender(\r\n\t\tReact.createElement(LoadingContainer, {\r\n\t\t\t// ref: setRef,\r\n\t\t\tonHidden: () => {\r\n\t\t\t\t// https://github.com/facebook/react/issues/21441#issuecomment-833298271\r\n\t\t\t\t// ReactDOM.unmountComponentAtNode(container)\r\n\t\t\t\troot.unmount()\r\n\t\t\t\tdocument.body.removeChild(container)\r\n\t\t\t},\r\n\t\t\taddHiddenListener: (listener) => {\r\n\t\t\t\tonHideInitialPreloadListeners.push(listener)\r\n\t\t\t}\r\n\t\t}),\r\n\t\tcontainer\r\n\t)\r\n}\r\n\r\nexport function hideInitialPreload() {\r\n\t// const container = containers.pop()\r\n\t// const ref = refs.pop()\r\n\r\n\t// ref.setFinishedLoading(() => {\r\n\t// \tsetTimeout(() => {\r\n\t// \t\tReactDOM.unmountComponentAtNode(container)\r\n\t// \t\tdocument.body.removeChild(container)\r\n\t// \t}, 160)\r\n\t// })\r\n\r\n\tfor (const onHideInitialPreloadListener of onHideInitialPreloadListeners) {\r\n\t\tonHideInitialPreloadListener()\r\n\t}\r\n}"],"mappings":";;;;;;;;AAAA;AACA;AAEA;AACA;AAAqD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAErD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA,IAAMA,6BAA6B,GAAG,EAAE;AACxC,IAAMC,wBAAwB,GAAG,IAAI;AAErC,SAASC,gBAAgB,OAAkCC,GAAG,EAAE;EAAA,IAApCC,QAAQ,QAARA,QAAQ;IAAEC,iBAAiB,QAAjBA,iBAAiB;EACtD,gBAA8B,IAAAC,eAAQ,EAAC,IAAI,CAAC;IAAA;IAArCC,OAAO;IAAEC,UAAU;;EAE1B;EACA,IAAMC,aAAa,GAAG,IAAAC,aAAM,GAAE;;EAE9B;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;;EAEA,IAAMC,MAAM,GAAG,SAATA,MAAM,GAAS;IACpBH,UAAU,CAAC,KAAK,CAAC;IACjBC,aAAa,CAACG,OAAO,GAAGC,UAAU,CAACT,QAAQ,EAAE,GAAG,CAAC;EAClD,CAAC;EAED,IAAAU,gBAAS,EAAC,YAAM;IACf,IAAI,CAACb,wBAAwB,EAAE;MAC9BU,MAAM,EAAE;IACT,CAAC,MAAM;MACNN,iBAAiB,CAACM,MAAM,CAAC;IAC1B;IACA,OAAO,YAAM;MACZI,YAAY,CAACN,aAAa,CAACG,OAAO,CAAC;IACpC,CAAC;EACF,CAAC,EAAE,EAAE,CAAC;EAEN,OAAOI,iBAAK,CAACC,aAAa,CAACC,gBAAO,EAAE;IACnCC,OAAO,EAAEZ,OAAO;IAChBa,SAAS,EAAEb,OAAO;IAClBc,OAAO,EAAEd;EACV,CAAC,CAAC;AACH;AAEAL,gBAAgB,GAAGc,iBAAK,CAACM,UAAU,CAACpB,gBAAgB,CAAC;AAE9C,SAASqB,kBAAkB,GAAG;EACpC,IAAMC,SAAS,GAAGC,QAAQ,CAACR,aAAa,CAAC,KAAK,CAAC;EAC/C;;EAEA;EACA;EACAQ,QAAQ,CAACC,IAAI,CAACC,YAAY,CAACH,SAAS,EAAEC,QAAQ,CAACC,IAAI,CAACE,UAAU,CAAC;;EAE/D;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA,mBAAiB,IAAAC,wBAAW,EAC3Bb,iBAAK,CAACC,aAAa,CAACf,gBAAgB,EAAE;MACrC;MACAE,QAAQ,EAAE,oBAAM;QACf;QACA;QACA0B,IAAI,CAACC,OAAO,EAAE;QACdN,QAAQ,CAACC,IAAI,CAACM,WAAW,CAACR,SAAS,CAAC;MACrC,CAAC;MACDnB,iBAAiB,EAAE,2BAAC4B,QAAQ,EAAK;QAChCjC,6BAA6B,CAACkC,IAAI,CAACD,QAAQ,CAAC;MAC7C;IACD,CAAC,CAAC,EACFT,SAAS,CACT;IAdOM,IAAI,gBAAJA,IAAI;AAeb;AAEO,SAASK,kBAAkB,GAAG;EACpC;EACA;EAEA;EACA;EACA;EACA;EACA;EACA;EAAA,2CAE2CnC,6BAA6B;IAAA;EAAA;IAAxE,oDAA0E;MAAA,IAA/DoC,4BAA4B;MACtCA,4BAA4B,EAAE;IAC/B;EAAC;IAAA;EAAA;IAAA;EAAA;AACF"}