{"version":3,"file":"websocket.js","names":["websocket","host","port","secure","store","autoDispatch","_websocket","RobustWebSocket","undefined","shouldReconnect","event","code","jitter","Math","min","pow","attempts","send","message","JSON","stringify","close","listen","event_name","listener","enhanced_listener","addEventListener","removeEventListener","onOpen","onClose","onError","onMessage","parse","data","socket","type","dispatch","window","value","amount","random"],"sources":["../../lib/websocket/websocket.js"],"sourcesContent":["import RobustWebSocket from '../../client/robust-websocket.js'\r\n\r\n// Sets up WebSocket connection.\r\nexport default function websocket({ host, port, secure, store, autoDispatch })\r\n{\r\n\tconst _websocket = new RobustWebSocket(`${secure ? 'wss' : 'ws'}://${host}:${port}`, undefined,\r\n\t{\r\n\t\t// If a number returned then it's gonna be a delay\r\n\t\t// before reconnect is attempted.\r\n\t\t// If anything else is returned (`null`, `undefined`, `false`)\r\n\t\t// then it means \"don't try to reconnect\".\r\n\t\t//\r\n\t\t// `event` is either a `CloseEvent`\r\n\t\t// or an online/offline `navigator` event.\r\n\t\t//\r\n\t\tshouldReconnect(event, websocket)\r\n\t\t{\r\n\t\t\t// https://github.com/appuri/robust-websocket/issues/8\r\n\t\t\t//\r\n\t\t\t// 1011 (500) is not retried by the default shouldReconnect.\r\n\t\t\t// a 500 will usually either be a big in the server\r\n\t\t\t// that the code is hitting, and retrying won't help,\r\n\t\t\t// or the server is down and getting slammed,\r\n\t\t\t// and retrying will just slam it more.\r\n\t\t\t// Sure the server will probably eventually come back up\r\n\t\t\t// so retrying it at a longer interval would be fine.\r\n\t\t\t//\r\n\t\t\t// 1008 (400) means the request you formed is bad.\r\n\t\t\t// If you try the exact same request again, you should always get 400.\r\n\t\t\t// 400 is not a transient error. If it is, the API is using the wrong status code.\r\n\t\t\t//\r\n\t\t\tif (event.code === 1008 || event.code === 1011)\r\n\t\t\t{\r\n\t\t\t\t// Retry in 30 minutes\r\n\t\t\t\treturn jitter(30 * 60 * 1000)\r\n\t\t\t}\r\n\r\n\t\t\t// Exponential backoff, but no less that once in a couple of minutes\r\n\t\t\treturn jitter(Math.min(Math.pow(1.5, websocket.attempts) * 500, 2 * 60 * 1000))\r\n\t\t}\r\n\t})\r\n\r\n\tconst websocket =\r\n\t{\r\n\t\tsend(message)\r\n\t\t{\r\n\t\t\treturn _websocket.send(JSON.stringify(message))\r\n\t\t},\r\n\r\n\t\tclose()\r\n\t\t{\r\n\t\t\treturn _websocket.close()\r\n\t\t},\r\n\r\n\t\tlisten(event_name, listener)\r\n\t\t{\r\n\t\t\tconst enhanced_listener = (event) => listener(event, store)\r\n\r\n\t\t\t_websocket.addEventListener(event_name, enhanced_listener)\r\n\r\n\t\t\t// Returns `unlisten()`\r\n\t\t\treturn () => _websocket.removeEventListener(event_name, enhanced_listener)\r\n\t\t},\r\n\r\n\t\tonOpen(listener)\r\n\t\t{\r\n\t\t\treturn websocket.listen('open', listener)\r\n\t\t},\r\n\r\n\t\tonClose(listener)\r\n\t\t{\r\n\t\t\treturn websocket.listen('close', listener)\r\n\t\t},\r\n\r\n\t\tonError(listener)\r\n\t\t{\r\n\t\t\treturn websocket.listen('error', listener)\r\n\t\t},\r\n\r\n\t\tonMessage(listener)\r\n\t\t{\r\n\t\t\treturn websocket.listen('message', (event, store) =>\r\n\t\t\t{\r\n\t\t\t\treturn listener(JSON.parse(event.data), store)\r\n\t\t\t})\r\n\t\t},\r\n\r\n\t\t// For advanced use cases\r\n\t\tsocket : _websocket\r\n\t}\r\n\r\n\tif (autoDispatch !== false)\r\n\t{\r\n\t\twebsocket.onMessage((message, store) =>\r\n\t\t{\r\n\t\t\tif (message.type)\r\n\t\t\t{\r\n\t\t\t\tstore.dispatch(message)\r\n\t\t\t}\r\n\t\t})\r\n\t}\r\n\r\n\treturn window.websocket = websocket\r\n}\r\n\r\n// Returns a value ranging from [value * (1 - amount)] to (value * (1 + amount))\r\nfunction jitter(value, amount = 0.2)\r\n{\r\n\treturn value * ((1 - amount) + amount * 2 * Math.random())\r\n}"],"mappings":"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"}