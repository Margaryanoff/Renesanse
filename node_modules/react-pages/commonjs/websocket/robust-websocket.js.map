{"version":3,"file":"robust-websocket.js","names":["window","PolyfillCustomEvent","RobustWebSocket","url","protocols","userOptions","realWs","close","connectTimeout","self","attempts","reconnects","reconnectWhenOnlineAgain","explicitlyClosed","pendingReconnect","opts","Object","assign","defaultOptions","shouldReconnect","timeout","Error","forEach","readOnlyProp","defineProperty","get","clearPendingReconnectIfNeeded","clearTimeout","ononline","event","reconnect","onoffline","connectivityEventsAttached","detachConnectivityEvents","global","removeEventListener","attachConnectivityEvents","addEventListener","send","apply","arguments","code","reason","open","readyState","WebSocket","OPEN","CONNECTING","newWebSocket","handle1000","navigator","onLine","delay","setTimeout","value","enumerable","undefined","binaryType","dispatchEvent","CustomEvent","stdEvent","cb","ignoreConnectivityEvents","automaticOpen","ws","prototype","type","callback","listeners","push","stack","i","l","length","splice","call"],"sources":["../../lib/websocket/robust-websocket.js"],"sourcesContent":["// Copy-pasted from `robust-websocket` library:\r\n// https://github.com/appuri/robust-websocket/blob/master/robust-websocket.js\r\n// A copy from October 9th 2017.\r\n//\r\n// Changes:\r\n//\r\n// * `robust-websocket` uses `CustomEvent` which is not supported in Internet Explorer: replaced it with `./CustomEvent.js` polyfill.\r\n//\r\n// * Rewrote it with a proper ES6 export. Otherwise it would throw `navigator is undefined` on server side. https://github.com/appuri/robust-websocket/issues/9\r\n\r\n// `robust-websocket` uses `CustomEvent`\r\n// which is not supported in Internet Explorer.\r\nimport PolyfillCustomEvent from './CustomEvent'\r\n\r\n// Polyfill `CustomEvent` for Internet Explorer.\r\n//\r\n// `window` is `undefined` on server side.\r\n// This file will still be included on server side\r\n// because server side still uses common utilities like\r\n// `meta`, `load`, `redirect()`, `goto()`, etc,\r\n// and therefore it does `require('react-pages')`\r\n// which executes `react-pages/index.common.js`\r\n// which in turn executes this `if` condition.\r\n//\r\nif (typeof window !== 'undefined')\r\n{\r\n  PolyfillCustomEvent()\r\n}\r\n\r\nexport default function RobustWebSocket(url, protocols, userOptions) {\r\n  var realWs = { close: function() {} },\r\n      connectTimeout,\r\n      self = this,\r\n      attempts = 0,\r\n      reconnects = -1,\r\n      reconnectWhenOnlineAgain = false,\r\n      explicitlyClosed = false,\r\n      pendingReconnect,\r\n      opts = Object.assign({},\r\n        RobustWebSocket.defaultOptions,\r\n        typeof userOptions === 'function' ? { shouldReconnect: userOptions } : userOptions\r\n      )\r\n\r\n  if (typeof opts.timeout !== 'number') {\r\n    throw new Error('timeout must be the number of milliseconds to timeout a connection attempt')\r\n  }\r\n\r\n  if (typeof opts.shouldReconnect !== 'function') {\r\n    throw new Error('shouldReconnect must be a function that returns the number of milliseconds to wait for a reconnect attempt, or null or undefined to not reconnect.')\r\n  }\r\n\r\n  ['bufferedAmount', 'url', 'readyState', 'protocol', 'extensions'].forEach(function(readOnlyProp) {\r\n    Object.defineProperty(self, readOnlyProp, {\r\n      get: function() { return realWs[readOnlyProp] }\r\n    })\r\n  })\r\n\r\n  function clearPendingReconnectIfNeeded() {\r\n    if (pendingReconnect) {\r\n      clearTimeout(pendingReconnect)\r\n      pendingReconnect = null\r\n    }\r\n  }\r\n\r\n  var ononline = function(event) {\r\n    if (reconnectWhenOnlineAgain) {\r\n      clearPendingReconnectIfNeeded()\r\n      reconnect(event)\r\n    }\r\n  },\r\n  onoffline = function() {\r\n    reconnectWhenOnlineAgain = true\r\n    realWs.close(1000)\r\n  },\r\n  connectivityEventsAttached = false\r\n\r\n  function detachConnectivityEvents() {\r\n    if (connectivityEventsAttached) {\r\n      global.removeEventListener('online', ononline)\r\n      global.removeEventListener('offline', onoffline)\r\n      connectivityEventsAttached = false\r\n    }\r\n  }\r\n\r\n  function attachConnectivityEvents() {\r\n    if (!connectivityEventsAttached) {\r\n      global.addEventListener('online', ononline)\r\n      global.addEventListener('offline', onoffline)\r\n      connectivityEventsAttached = true\r\n    }\r\n  }\r\n\r\n  self.send = function() {\r\n    return realWs.send.apply(realWs, arguments)\r\n  }\r\n\r\n  self.close = function(code, reason) {\r\n    if (typeof code !== 'number') {\r\n      reason = code\r\n      code = 1000\r\n    }\r\n\r\n    clearPendingReconnectIfNeeded()\r\n    reconnectWhenOnlineAgain = false\r\n    explicitlyClosed = true\r\n    detachConnectivityEvents()\r\n\r\n    return realWs.close(code, reason)\r\n  }\r\n\r\n  self.open = function() {\r\n    if (realWs.readyState !== WebSocket.OPEN && realWs.readyState !== WebSocket.CONNECTING) {\r\n      clearPendingReconnectIfNeeded()\r\n      reconnectWhenOnlineAgain = false\r\n      explicitlyClosed = false\r\n\r\n      newWebSocket()\r\n    }\r\n  }\r\n\r\n  function reconnect(event) {\r\n    if ((!opts.shouldReconnect.handle1000 && event.code === 1000) || explicitlyClosed) {\r\n      attempts = 0\r\n      return\r\n    }\r\n    if (navigator.onLine === false) {\r\n      reconnectWhenOnlineAgain = true\r\n      return\r\n    }\r\n\r\n    var delay = opts.shouldReconnect(event, self)\r\n    if (typeof delay === 'number') {\r\n      pendingReconnect = setTimeout(newWebSocket, delay)\r\n    }\r\n  }\r\n\r\n  Object.defineProperty(self, 'listeners', {\r\n    value: {\r\n      open: [function(event) {\r\n        if (connectTimeout) {\r\n          clearTimeout(connectTimeout)\r\n          connectTimeout = null\r\n        }\r\n        event.reconnects = ++reconnects\r\n        event.attempts = attempts\r\n        attempts = 0\r\n        reconnectWhenOnlineAgain = false\r\n      }],\r\n      close: [reconnect]\r\n    }\r\n  })\r\n\r\n  Object.defineProperty(self, 'attempts', {\r\n    get: function() { return attempts },\r\n    enumerable: true\r\n  })\r\n\r\n  Object.defineProperty(self, 'reconnects', {\r\n    get: function() { return reconnects },\r\n    enumerable: true\r\n  })\r\n\r\n  function newWebSocket() {\r\n    pendingReconnect = null\r\n    realWs = new WebSocket(url, protocols || undefined)\r\n    realWs.binaryType = self.binaryType\r\n\r\n    attempts++\r\n    self.dispatchEvent(Object.assign(new CustomEvent('connecting'), {\r\n      attempts: attempts,\r\n      reconnects: reconnects\r\n    }))\r\n\r\n    connectTimeout = setTimeout(function() {\r\n      connectTimeout = null\r\n      detachConnectivityEvents()\r\n      self.dispatchEvent(Object.assign(new CustomEvent('timeout'), {\r\n        attempts: attempts,\r\n        reconnects: reconnects\r\n      }))\r\n    }, opts.timeout)\r\n\r\n    ;['open', 'close', 'message', 'error'].forEach(function(stdEvent) {\r\n      realWs.addEventListener(stdEvent, function(event) {\r\n        self.dispatchEvent(event)\r\n\r\n        var cb = self['on' + stdEvent]\r\n        if (typeof cb === 'function') {\r\n          return cb.apply(self, arguments)\r\n        }\r\n      })\r\n    })\r\n\r\n    if (!opts.ignoreConnectivityEvents) {\r\n      attachConnectivityEvents()\r\n    }\r\n  }\r\n\r\n  if (opts.automaticOpen) {\r\n    newWebSocket()\r\n  }\r\n}\r\n\r\nRobustWebSocket.defaultOptions = {\r\n  // the time to wait before a successful connection\r\n  // before the attempt is considered to have timed out\r\n  timeout: 4000,\r\n  // Given a CloseEvent or OnlineEvent and the RobustWebSocket state,\r\n  // should a reconnect be attempted? Return the number of milliseconds to wait\r\n  // to reconnect (or null or undefined to not), rather than true or false\r\n  shouldReconnect: function(event, ws) {\r\n    if (event.code === 1008 || event.code === 1011) return\r\n    return [0, 3000, 10000][ws.attempts]\r\n  },\r\n\r\n  // Flag to control whether attachement to navigator online/offline events\r\n  // should be disabled.\r\n  ignoreConnectivityEvents: false,\r\n\r\n  // Create and connect the WebSocket when the instance is instantiated.\r\n  // Defaults to true to match standard WebSocket behavior\r\n  automaticOpen: true\r\n}\r\n\r\nRobustWebSocket.prototype.binaryType = 'blob'\r\n\r\n// Taken from MDN https://developer.mozilla.org/en-US/docs/Web/API/EventTarget\r\nRobustWebSocket.prototype.addEventListener = function(type, callback) {\r\n  if (!(type in this.listeners)) {\r\n    this.listeners[type] = []\r\n  }\r\n  this.listeners[type].push(callback)\r\n}\r\n\r\nRobustWebSocket.prototype.removeEventListener = function(type, callback) {\r\n  if (!(type in this.listeners)) {\r\n    return\r\n  }\r\n  var stack = this.listeners[type]\r\n  for (var i = 0, l = stack.length; i < l; i++) {\r\n    if (stack[i] === callback) {\r\n      stack.splice(i, 1)\r\n      return\r\n    }\r\n  }\r\n}\r\n\r\nRobustWebSocket.prototype.dispatchEvent = function(event) {\r\n  if (!(event.type in this.listeners)) {\r\n    return\r\n  }\r\n  var stack = this.listeners[event.type]\r\n  for (var i = 0, l = stack.length; i < l; i++) {\r\n    stack[i].call(this, event)\r\n  }\r\n}"],"mappings":"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"}