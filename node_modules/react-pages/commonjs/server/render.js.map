{"version":3,"file":"render.js","names":["settings","generateOuterHtmlBeforeContent","generateOuterHtmlAfterContent","bodyEnd","html","path","parameters","renderAfterContent","javascript","generateJavascript","assets","locales","serverSideRender","contentNotRendered","renderContent","meta","head","bodyStart","renderBeforeContent","locale","convertOpenGraphLocaleToLanguageTag","getMetaTagsMarkup","join","proxy","url","origin","cookies","headers","getLoadContext","getInitialState","normalizeSettings","routes","rootComponent","codeSplit","location","parseLocationUrl","pathname","replace","render","reduxRender","reduxInitialize","newCookies","entries","main","Error","mergeMeta","pageMeta","undefined","rootMeta","Component","useSelector","getter","store","getState","stash","beforeContent","afterContent","route","status","content","createStringStream","redirect","rootComponentProps","time","prependBasenameToUrl","basename","streams","pageElement","React","createElement","push","createRenderingStream","MultiStream","getLocationUrl"],"sources":["../../lib/server/render.js"],"sourcesContent":["import React from 'react'\r\nimport createStringStream from 'string-to-stream'\r\nimport MultiStream from 'multistream'\r\n\r\nimport { renderBeforeContent, renderAfterContent } from './html.js'\r\nimport normalizeSettings from '../redux/normalize.js'\r\nimport timer from '../timer.js'\r\nimport parseLocationUrl from '../parseLocationUrl.js'\r\nimport getLocationUrl from '../getLocationUrl.js'\r\nimport reduxRender from '../redux/server/render.js'\r\nimport { initialize as reduxInitialize } from '../redux/server/server.js'\r\nimport mergeMeta from '../meta/mergeMeta.js'\r\nimport getMetaTagsMarkup from '../meta/getMetaTagsMarkup.js'\r\nimport convertOpenGraphLocaleToLanguageTag from '../meta/convertOpenGraphLocaleToLanguageTag.js'\r\nimport { createRenderingStream } from './reactRender.js'\r\n\r\nexport default async function(settings, {\r\n\tassets,\r\n\tproxy,\r\n\turl,\r\n\torigin,\r\n\trenderContent,\r\n\thtml = {},\r\n\tcookies,\r\n\tlocales,\r\n\theaders,\r\n\tgetLoadContext,\r\n\tgetInitialState\r\n}) {\r\n\tsettings = normalizeSettings(settings)\r\n\r\n\tconst {\r\n\t\troutes,\r\n\t\trootComponent,\r\n\t\tcodeSplit\r\n\t} = settings\r\n\r\n\t// `url` is obtained from Node.js `request.url` property,\r\n\t// which is always a relative URL.\r\n\t// https://nodejs.org/api/http.html#messageurl\r\n\tconst location = parseLocationUrl(url)\r\n\tconst path = location.pathname.replace(/\\/$/, '')\r\n\r\n\t// A special `base.html` page for static sites.\r\n\t// (e.g. the ones hosted on Amazon S3)\r\n\tlet serverSideRender = true\r\n\tif (path === '/react-pages-base') {\r\n\t\tserverSideRender = false\r\n\t}\r\n\r\n\t// If Redux is being used, then render for Redux.\r\n\t// Else render for pure React.\r\n\tconst render = reduxRender\r\n\r\n\t// `parameters` are used for `assets` and `html` modifiers.\r\n\tconst {\r\n\t\tcookies: newCookies,\r\n\t\tgenerateJavascript,\r\n\t\t...parameters\r\n\t} = await reduxInitialize(settings, {\r\n\t\tproxy,\r\n\t\tcookies,\r\n\t\theaders,\r\n\t\tlocales,\r\n\t\turl,\r\n\t\torigin,\r\n\t\tlocation,\r\n\t\tgetLoadContext,\r\n\t\tgetInitialState\r\n\t})\r\n\r\n\t// Normalize assets type and shape.\r\n\tassets = typeof assets === 'function' ? assets(path, parameters) : assets\r\n\tif (!assets.entries) {\r\n\t\t// Default `assets.entries` to `[\"main\"]`.\r\n\t\tif (assets.javascript && assets.javascript.main) {\r\n\t\t\tassets.entries = ['main']\r\n\t\t} else {\r\n\t\t\tthrow new Error(`\"assets.entries[]\" configuration parameter is required: it includes all Webpack \"entries\" for which javascripts and styles must be included on a server-rendered page. If you didn't set up any custom \"entries\" in Webpack configuration then the default Webpack entry is called \"main\". You don't seem to have the \"main\" entry so the server doesn't know which assets to include on the page (\"['main']\" is the default value for \"assets.entries\").`)\r\n\t\t}\r\n\t}\r\n\r\n\tfunction generateOuterHtmlBeforeContent({ meta }) {\r\n\t\t// `html` modifiers\r\n\t\tlet { head, bodyStart } = html\r\n\r\n\t\t// Normalize `html` parameters\r\n\t\thead = typeof head === 'function' ? head(path, parameters) : head\r\n\t\tbodyStart = typeof bodyStart === 'function' ? bodyStart(path, parameters) : bodyStart\r\n\r\n\t\t// Render all HTML that goes before React markup.\r\n\t\treturn renderBeforeContent({\r\n\t\t\tassets,\r\n\t\t\tlocale: meta.locale && convertOpenGraphLocaleToLanguageTag(meta.locale),\r\n\t\t\tmeta: getMetaTagsMarkup(meta).join(''),\r\n\t\t\thead,\r\n\t\t\tbodyStart\r\n\t\t})\r\n\t}\r\n\r\n\tfunction generateOuterHtmlAfterContent() {\r\n\t\t// `html` modifiers\r\n\t\tlet { bodyEnd } = html\r\n\r\n\t\t// Normalize `html` parameters\r\n\t\tbodyEnd = typeof bodyEnd === 'function' ? bodyEnd(path, parameters) : bodyEnd\r\n\r\n\t\t// Render all HTML that goes after React markup\r\n\t\treturn renderAfterContent({\r\n\t\t\tjavascript: generateJavascript(),\r\n\t\t\tassets,\r\n\t\t\tlocales,\r\n\t\t\tbodyEnd,\r\n\t\t\tserverSideRender,\r\n\t\t\tcontentNotRendered: renderContent === false\r\n\t\t})\r\n\t}\r\n\r\n\t// A special `base.html` page for static sites.\r\n\t// (e.g. the ones hosted on Amazon S3)\r\n\tif (!serverSideRender) {\r\n\t\t// Get `<meta/>` tags for `/react-pages-base` route.\r\n\t\tconst meta = mergeMeta({\r\n\t\t\tpageMeta: undefined,\r\n\t\t\trootMeta: codeSplit ? routes[0].meta : routes[0].Component.meta,\r\n\t\t\tuseSelector: (getter) => getter(parameters.store.getState()),\r\n\t\t\tstash: parameters.stash\r\n\t\t})\r\n\t\tconst beforeContent = generateOuterHtmlBeforeContent({ meta })\r\n\t\tconst afterContent = generateOuterHtmlAfterContent()\r\n\t\treturn {\r\n\t\t\troute: '/react-pages-base',\r\n\t\t\tstatus: 200,\r\n\t\t\tcontent: createStringStream(beforeContent + afterContent),\r\n\t\t\tcookies: []\r\n\t\t}\r\n\t}\r\n\r\n\t// Render page content to a `React.Element`.\r\n\tconst {\r\n\t\tredirect,\r\n\t\troute,\r\n\t\tstatus,\r\n\t\tcontent,\r\n\t\tmeta,\r\n\t\trootComponentProps,\r\n\t\ttime\r\n\t} = await render({\r\n\t\t...parameters,\r\n\t\t// routes,\r\n\t\tcodeSplit\r\n\t})\r\n\r\n\tif (redirect) {\r\n\t\t// Prepend `basename` to relative URLs for server-side redirect.\r\n\t\treturn {\r\n\t\t\tredirect: {\r\n\t\t\t\t...redirect,\r\n\t\t\t\turl: prependBasenameToUrl(redirect.url, settings.basename)\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tconst beforeContent = generateOuterHtmlBeforeContent({ meta })\r\n\r\n\tconst streams = [\r\n\t\tcreateStringStream(beforeContent)\r\n\t]\r\n\r\n\tif (renderContent !== false) {\r\n\t\t// Render page content to a `Stream`\r\n\t\t// inserting this stream in the middle of `streams` array.\r\n\t\t// `array.splice(index, 0, element)` inserts `element` at `index`.\r\n\t\tconst pageElement = React.createElement(rootComponent, rootComponentProps, content)\r\n\t\tstreams.push(createRenderingStream(pageElement))\r\n\t}\r\n\r\n\t// Generating `afterContent` should wait for the React 18 rendering process\r\n\t// to finish: that's because there can be \"Suspense\" calls that might fetch data\r\n\t// and, therefore, modify Redux state.\r\n\tconst afterContent = generateOuterHtmlAfterContent()\r\n\tstreams.push(createStringStream(afterContent))\r\n\r\n\treturn {\r\n\t\troute,\r\n\t\tstatus,\r\n\t\tcontent: new MultiStream(streams),\r\n\t\ttime,\r\n\t\tcookies: newCookies\r\n\t}\r\n}\r\n\r\nfunction prependBasenameToUrl(url, basename) {\r\n\tif (typeof url === 'string') {\r\n\t\treturn (basename || '') + url\r\n\t}\r\n\treturn getLocationUrl(url, { basename })\r\n}"],"mappings":"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"}