{"version":3,"file":"HttpClient.js","names":["HTTP_METHODS","HttpClient","options","fetch","server","proxy","headers","cookies","useCrossDomainCookies","authTokenHeader","onBeforeSend","catchToRetry","getAuthToken","shouldParseJsonDates","parseDates","transformUrl","proxyUrl","bind","cookiesSetOnServer","getCookie","name","cookieRaw","indexOf","getCookieKeyAndValue","key","value","_getCookie","agent","superagent","method","originalUrl","data","url","retryCount","performHttpRequest","request","HttpRequest","onResponseHeaders","getDomain","getDomainFromUrl","belongsToDomain","domain","urlBelongsToDomain","onAddCookies","cookie","push","addAuthenticationToken","authentication","isRelativeUrl","addCookies","progress","send","then","response","error","http","protocol","secure","host","port"],"sources":["../lib/HttpClient.js"],"sourcesContent":["import superagent from 'superagent'\r\n\r\nimport { getCookie as _getCookie } from './client/cookies.js'\r\nimport HttpRequest, { getCookieKeyAndValue } from './HttpRequest.js'\r\nimport getDomainFromUrl from './getDomainFromUrl.js'\r\nimport urlBelongsToDomain from './urlBelongsToDomain.js'\r\n\r\nconst HTTP_METHODS = [\r\n\t'get',\r\n\t'post',\r\n\t'put',\r\n\t'patch',\r\n\t'delete',\r\n\t'head',\r\n\t'options'\r\n]\r\n\r\n// This is an isomorphic (universal) HTTP client\r\n// which works both on Node.js and in the web browser,\r\n// and therefore can be used in Redux actions (for HTTP requests)\r\nexport default class HttpClient {\r\n\t// Constructs a new instance of Http client.\r\n\t// Optionally takes an Http Request as a reference to mimic\r\n\t// (in this case, cookies, to make authentication work on the server-side).\r\n\tconstructor(options = {}) {\r\n\t\tconst {\r\n\t\t\t// Currently, `fetch` is not used.\r\n\t\t\t// But it could be used in some future instead of `superagent`.\r\n\t\t\t// There was a bug in `superagent` related to cookies not being set\r\n\t\t\t// during CORS HTTP requests, but that seems to be resolved in version `8.0.0`.\r\n\t\t\t// https://github.com/visionmedia/superagent/issues/1172\r\n\t\t\tfetch,\r\n\t\t\tserver,\r\n\t\t\tproxy,\r\n\t\t\theaders,\r\n\t\t\t// On server side, copies cookies from the original HTTP request\r\n\t\t\t// to all subsequent (nested) HTTP requests that might originate\r\n\t\t\t// in a page's `load()` function.\r\n\t\t\tcookies,\r\n\t\t\tuseCrossDomainCookies,\r\n\t\t\tauthTokenHeader,\r\n\t\t\tonBeforeSend,\r\n\t\t\tcatchToRetry,\r\n\t\t\tgetAuthToken\r\n\t\t} = options\r\n\r\n\t\tconst shouldParseJsonDates = options.parseDates !== false\r\n\r\n\t\tconst transformUrl = options.transformUrl || this.proxyUrl.bind(this)\r\n\r\n\t\tthis.server = server\r\n\t\tthis.proxy = proxy\r\n\r\n\t\t// `Set-Cookie` HTTP headers\r\n\t\t// (in case any cookies are set)\r\n\t\t// cookiesSetOnServer = new Set()\r\n\t\tthis.cookiesSetOnServer = []\r\n\r\n\t\t// \"Get cookie value by name\" helper (works both on client and server)\r\n\t\tconst getCookie = this.server\r\n\t\t?\r\n\t\t((name) => {\r\n\t\t\t// If this cookie was set dynamically then return it\r\n\t\t\tfor (const cookieRaw of this.cookiesSetOnServer) {\r\n\t\t\t\tif (cookieRaw.indexOf(`${name}=`) === 0) {\r\n\t\t\t\t\tconst [key, value] = getCookieKeyAndValue(cookieRaw)\r\n\t\t\t\t\treturn value\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t// Return the original request cookie\r\n\t\t\treturn cookies[name]\r\n\t\t})\r\n\t\t:\r\n\t\t_getCookie\r\n\r\n\t\t// `superagent` doesn't save cookies by default on the server side.\r\n\t\t// Therefore calling `.agent()` explicitly to enable setting cookies.\r\n\t\tconst agent = this.server ? superagent.agent() : superagent\r\n\r\n\t\t// Define HTTP methods on this `http` utility instance\r\n\t\tfor (const method of HTTP_METHODS) {\r\n\t\t\tthis[method] = (originalUrl, data, options = {}) => {\r\n\t\t\t\t// `url` will be absolute for server-side\r\n\t\t\t\tconst url = transformUrl(originalUrl, { server: this.server })\r\n\r\n\t\t\t\t// Is incremented on each retry\r\n\t\t\t\tlet retryCount = -1\r\n\r\n\t\t\t\t// Performs an HTTP request to the given `url`.\r\n\t\t\t\t// Can retry itself.\r\n\t\t\t\tconst performHttpRequest = () => {\r\n\t\t\t\t\t// Create Http request\r\n\t\t\t\t\tconst request = new HttpRequest(method, url, data, {\r\n\t\t\t\t\t\tagent,\r\n\t\t\t\t\t\tshouldParseJsonDates,\r\n\t\t\t\t\t\tonResponseHeaders: options.onResponseHeaders,\r\n\t\t\t\t\t\theaders: { ...headers, ...options.headers },\r\n\t\t\t\t\t\tuseCrossDomainCookies: useCrossDomainCookies && useCrossDomainCookies({\r\n\t\t\t\t\t\t\tgetDomain: () => getDomainFromUrl(url),\r\n\t\t\t\t\t\t\tbelongsToDomain: (domain) => urlBelongsToDomain(url, domain),\r\n\t\t\t\t\t\t\turl,\r\n\t\t\t\t\t\t\toriginalUrl\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t\tonAddCookies: (cookies) => {\r\n\t\t\t\t\t\t\tif (this.server) {\r\n\t\t\t\t\t\t\t\t// Cookies will be duplicated here\r\n\t\t\t\t\t\t\t\t// because `superagent.agent()` persists\r\n\t\t\t\t\t\t\t\t// `Set-Cookie`s between subsequent requests\r\n\t\t\t\t\t\t\t\t// (i.e. for the same `HttpClient` instance).\r\n\t\t\t\t\t\t\t\t// Therefore using a `Set` instead of an array.\r\n\t\t\t\t\t\t\t\tfor (const cookie of cookies) {\r\n\t\t\t\t\t\t\t\t\t// this.cookiesSetOnServer.add(cookie)\r\n\t\t\t\t\t\t\t\t\tif (this.cookiesSetOnServer.indexOf(cookie) < 0) {\r\n\t\t\t\t\t\t\t\t\t\tthis.cookiesSetOnServer.push(cookie)\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\r\n\t\t\t\t\t// Sets `Authorization: Bearer ${token}` in HTTP request header\r\n\t\t\t\t\trequest.addAuthenticationToken(\r\n\t\t\t\t\t\tauthTokenHeader,\r\n\t\t\t\t\t\toptions.authentication,\r\n\t\t\t\t\t\tgetAuthToken,\r\n\t\t\t\t\t\tgetCookie,\r\n\t\t\t\t\t\turl,\r\n\t\t\t\t\t\toriginalUrl\r\n\t\t\t\t\t)\r\n\r\n\t\t\t\t\t// On server side, user's cookies are attached to **all** relative \"original\" URLs\r\n\t\t\t\t\t// so `http.transformUrl(originalUrl)` must not transform relative URLs\r\n\t\t\t\t\t// into absolute URLs, otherwise user's cookies would be leaked to a third party.\r\n\t\t\t\t\tif (this.server && isRelativeUrl(originalUrl)) {\r\n\t\t\t\t\t\trequest.addCookies(cookies, this.cookiesSetOnServer)\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Allows customizing HTTP requests.\r\n\t\t\t\t\t// (for example, setting some HTTP headers,\r\n\t\t\t\t\t//  or changing HTTP request `Content-Type`).\r\n\t\t\t\t\t// https://github.com/catamphetamine/react-website/issues/73\r\n\t\t\t\t\tif (onBeforeSend) {\r\n\t\t\t\t\t\tonBeforeSend(request.request, {\r\n\t\t\t\t\t\t\turl,\r\n\t\t\t\t\t\t\toriginalUrl\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// File upload progress metering\r\n\t\t\t\t\t// https://developer.mozilla.org/en/docs/Web/API/XMLHttpRequest/Using_XMLHttpRequest\r\n\t\t\t\t\tif (options.progress) {\r\n\t\t\t\t\t\trequest.progress(options.progress)\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\treturn request.send().then(\r\n\t\t\t\t\t\t(response) => response,\r\n\t\t\t\t\t\t(error) => {\r\n\t\t\t\t\t\t\t// `superagent` would have already output the error to console\r\n\t\t\t\t\t\t\t// console.error(error.stack)\r\n\t\t\t\t\t\t\t// Can optionally retry an HTTP request in case of an error\r\n\t\t\t\t\t\t\t// (e.g. if a JWT access token expired and has to be refreshed using a \"refresh\" token).\r\n\t\t\t\t\t\t\t// https://auth0.com/blog/refresh-tokens-what-are-they-and-when-to-use-them/\r\n\t\t\t\t\t\t\tif (catchToRetry) {\r\n\t\t\t\t\t\t\t\tretryCount++\r\n\t\t\t\t\t\t\t\treturn catchToRetry(error, retryCount, {\r\n\t\t\t\t\t\t\t\t\tgetCookie,\r\n\t\t\t\t\t\t\t\t\thttp: this\r\n\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t.then(performHttpRequest)\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t// HTTP request failed with an `error`\r\n\t\t\t\t\t\t\tthrow error\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t)\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn performHttpRequest()\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t// Validates the requested URL,\r\n\t// and also prepends host and port to it on the server side.\r\n\tproxyUrl(url, { server }) {\r\n\t\t// Prepend host and port on the server side\r\n\t\tif (this.proxy && server && isRelativeUrl(url)) {\r\n\t\t\tconst protocol = this.proxy.secure ? 'https' : 'http'\r\n\t\t\treturn `${protocol}://${this.proxy.host}:${this.proxy.port || '80'}${url}`\r\n\t\t}\r\n\t\treturn url\r\n\t}\r\n}\r\n\r\nfunction isRelativeUrl(url) {\r\n\t// Skip \"same protocol\" URLs.\r\n\t// Example: \"//yandex.ru\".\r\n\treturn url[0] === '/' && url[1] !== '/'\r\n}"],"mappings":"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"}