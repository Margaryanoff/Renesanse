{"version":3,"file":"applyMeta.js","names":["browserDocument","BrowserDocument","applyMeta","meta","document","window","setInContext","title","charset","normalizeMeta","metaTags","getMetaTags","getTitle","setTitle","updateMetaTag","newMetaTags","compact","map","key","value","forEach","removeMetaTag","addMetaTag","name","i","length","meta_tag","isMetaTag","getMetaTagValue","setMetaTagValue","splice"],"sources":["../../lib/meta/applyMeta.js"],"sourcesContent":["// import { compact } from 'lodash-es'\r\nimport compact from 'lodash/compact.js'\r\n\r\nimport BrowserDocument from './BrowserDocument.js'\r\nimport normalizeMeta from './normalizeMeta.js'\r\nimport expandArrays from './expandArrays.js'\r\nimport expandObjects from './expandObjects.js'\r\n\r\nimport escapeHtml from '../escapeHtml.js'\r\nimport { setInContext } from '../context.js'\r\n\r\nconst browserDocument = new BrowserDocument()\r\n\r\n/**\r\n * Updates `<title/>` and `<meta/>` tags (inside `<head/>`).\r\n */\r\nexport default function applyMeta(meta, document = browserDocument) {\r\n\t// Tests don't have a `window` global variable.\r\n\tif (typeof window !== 'undefined') {\r\n\t\t// `patchMeta()` function uses the latest applied meta snapshot.\r\n\t\tsetInContext('App/LatestAppliedMeta', meta)\r\n\t}\r\n\r\n\tconst { title, charset } = meta\r\n\tmeta = normalizeMeta(meta)\r\n\r\n\t// Get all `<meta/>` tags.\r\n\t// (will be mutated)\r\n\tconst metaTags = document.getMetaTags()\r\n\r\n\t// Update `<title/>`.\r\n\tif (title && document.getTitle() !== title) {\r\n\t\tdocument.setTitle(title)\r\n\t}\r\n\r\n\t// Update `<meta charset/>`.\r\n\tif (charset) {\r\n\t\tupdateMetaTag(document, metaTags, 'charset', charset)\r\n\t}\r\n\r\n\t// Update existing `<meta/>` tags.\r\n\t// (removing them from `metaTags` array)\r\n\tconst newMetaTags = compact(\r\n\t\tmeta.map(([key, value]) => {\r\n\t\t\tif (!updateMetaTag(document, metaTags, key, value)) {\r\n\t\t\t\treturn [key, value]\r\n\t\t\t}\r\n\t\t})\r\n\t)\r\n\r\n\t// Delete no longer existent `<meta/>` tags.\r\n\tmetaTags.forEach(document.removeMetaTag)\r\n\r\n\t// Create new `<meta/>` tags.\r\n\tfor (const [key, value] of newMetaTags) {\r\n\t\tdocument.addMetaTag(key, value)\r\n\t}\r\n}\r\n\r\n/**\r\n * Updates `<meta/>` tag to a new `value` and removes it from `metaTags`.\r\n * @param {Document} document - `BrowserDocument` or `TestDocument`.\r\n * @return {boolean?}\r\n */\r\nfunction updateMetaTag(document, metaTags, name, value) {\r\n\tlet i = 0\r\n\twhile (i < metaTags.length) {\r\n\t\tconst meta_tag = metaTags[i]\r\n\t\tif (document.isMetaTag(meta_tag, name)) {\r\n\t\t\t// Update `<meta/>` tag `value`.\r\n\t\t\tif (document.getMetaTagValue(meta_tag) !== value) {\r\n\t\t\t\tdocument.setMetaTagValue(meta_tag, value)\r\n\t\t\t}\r\n\t\t\t// Remove it from `metaTags`.\r\n\t\t\tmetaTags.splice(i, 1)\r\n\t\t\t// Updated.\r\n\t\t\treturn true\r\n\t\t}\r\n\t\ti++\r\n\t}\r\n}"],"mappings":";;;;;;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAA4C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAE5C,IAAMA,eAAe,GAAG,IAAIC,2BAAe,EAAE;;AAE7C;AACA;AACA;AACe,SAASC,SAAS,CAACC,IAAI,EAA8B;EAAA,IAA5BC,QAAQ,uEAAGJ,eAAe;EACjE;EACA,IAAI,OAAOK,MAAM,KAAK,WAAW,EAAE;IAClC;IACA,IAAAC,qBAAY,EAAC,uBAAuB,EAAEH,IAAI,CAAC;EAC5C;EAEA,YAA2BA,IAAI;IAAvBI,KAAK,SAALA,KAAK;IAAEC,OAAO,SAAPA,OAAO;EACtBL,IAAI,GAAG,IAAAM,yBAAa,EAACN,IAAI,CAAC;;EAE1B;EACA;EACA,IAAMO,QAAQ,GAAGN,QAAQ,CAACO,WAAW,EAAE;;EAEvC;EACA,IAAIJ,KAAK,IAAIH,QAAQ,CAACQ,QAAQ,EAAE,KAAKL,KAAK,EAAE;IAC3CH,QAAQ,CAACS,QAAQ,CAACN,KAAK,CAAC;EACzB;;EAEA;EACA,IAAIC,OAAO,EAAE;IACZM,aAAa,CAACV,QAAQ,EAAEM,QAAQ,EAAE,SAAS,EAAEF,OAAO,CAAC;EACtD;;EAEA;EACA;EACA,IAAMO,WAAW,GAAG,IAAAC,mBAAO,EAC1Bb,IAAI,CAACc,GAAG,CAAC,gBAAkB;IAAA;MAAhBC,GAAG;MAAEC,KAAK;IACpB,IAAI,CAACL,aAAa,CAACV,QAAQ,EAAEM,QAAQ,EAAEQ,GAAG,EAAEC,KAAK,CAAC,EAAE;MACnD,OAAO,CAACD,GAAG,EAAEC,KAAK,CAAC;IACpB;EACD,CAAC,CAAC,CACF;;EAED;EACAT,QAAQ,CAACU,OAAO,CAAChB,QAAQ,CAACiB,aAAa,CAAC;;EAExC;EAAA,2CAC2BN,WAAW;IAAA;EAAA;IAAtC,oDAAwC;MAAA;QAA5BG,GAAG;QAAEC,KAAK;MACrBf,QAAQ,CAACkB,UAAU,CAACJ,GAAG,EAAEC,KAAK,CAAC;IAChC;EAAC;IAAA;EAAA;IAAA;EAAA;AACF;;AAEA;AACA;AACA;AACA;AACA;AACA,SAASL,aAAa,CAACV,QAAQ,EAAEM,QAAQ,EAAEa,IAAI,EAAEJ,KAAK,EAAE;EACvD,IAAIK,CAAC,GAAG,CAAC;EACT,OAAOA,CAAC,GAAGd,QAAQ,CAACe,MAAM,EAAE;IAC3B,IAAMC,QAAQ,GAAGhB,QAAQ,CAACc,CAAC,CAAC;IAC5B,IAAIpB,QAAQ,CAACuB,SAAS,CAACD,QAAQ,EAAEH,IAAI,CAAC,EAAE;MACvC;MACA,IAAInB,QAAQ,CAACwB,eAAe,CAACF,QAAQ,CAAC,KAAKP,KAAK,EAAE;QACjDf,QAAQ,CAACyB,eAAe,CAACH,QAAQ,EAAEP,KAAK,CAAC;MAC1C;MACA;MACAT,QAAQ,CAACoB,MAAM,CAACN,CAAC,EAAE,CAAC,CAAC;MACrB;MACA,OAAO,IAAI;IACZ;IACAA,CAAC,EAAE;EACJ;AACD"}